# 第5章 运输层
- 重要概念
	1. 运输层为相互通信的应用进程提供**逻辑通信**。
	2. 端口和套接字的意义。
	3. 无连接的UDP的意义。
	4. 面向连接的TCP的特点。
	5. 在不可靠的网络上实现可靠传输的工作原理，停止等待协议和ARQ协议。
	6. TCP的滑动窗口、流量控制、拥塞控制和连接管理。
## 5.1 运输层协议概述
### 5.1.1 进程之间的通信
- 只有**主机**的协议栈才有运输层，而网络核心部分中的**路由器**在转发分组时都只用到下三层的功能
- 从运输层的角度看，通信的真正端点并不是主机而是主机中的进程。**端到端的通信是应用进程之间的通信**
- **复用**（multiplexing）和**分用**（demultiplexing）
- **网络层**为**主机**之间提供逻辑通信，而**运输层**为**应用进程**之间提供端到端的逻辑通信
- 运输层还要对收到的报文进行**差错检查**
- 运输层需要有两种不同的运输协议
	- **面向连接的TCP**，一个全双工的可靠信道
	- **无连接的UDP**，一条不可靠信道
### 5.1.2 运输层的两个主要协议
- TCP/IP运输层的两个主要协议都是互联网的正式标准
	- **用户数据报协议 UDP（User Dategram Protocol）[RFC 768]**
	- **传输控制协议 TCP（Transmission Control Protocol）[RFC 793]**
<table>
    <tr>
        <td colspan="2" align="center">应用层</td>
    </tr>
    <tr>
        <td>UDP</td>
        <td>TCP</td>
    </tr>
    <tr>
        <td colspan="2" align="center">IP</td>
    </tr>
    <tr>
        <td colspan="2" align="center">与各种网络接口</td>
    </tr>
</table>

- TCP/IP体系中的**运输协议数据单元 TPDU（Transport Protocol Data Unit）**
	- **TCP报文段（segment）**
	- **UDP用户数据报**
- UDP在传送数据之前**不需要先建立连接**。远地主机的运输层在收到UDP报文后，不需要给出任何确认（不可靠但是效率高）
- TCP则提供面向连接的服务。在传送数据之前必须先建立连接，数据传送结束后要释放连接。TCP不提供广播或多播服务（可靠且面向连接但开销大）
- 使用UDP和TCP协议的各种应用和应用层协议

| 应用 | 应用层协议 | 运输层协议 |
|--|--|--|
| 名字转换 | DNS（域名系统） | UDP |
| 文件传送 | TFTP（简单文件传送协议） | UDP |
| 路由选择协议 | RIP（路由信息协议） | UDP |
| IP地址配置 | DHCP（动态主机配置协议） | UDP |
| 网络管理 | SNMP（简单网络管理协议） | UDP |
| IP电话 | 专用协议 | UDP |
| 流式多媒体通信 | 专用协议 | UDP |
| 多播 | IGMP（网际组管理协议） | UDP |
| 电子邮件 | SMTP（简单邮件传送协议） | TCP |
| 远程终端接入 | TELNET（远程终端协议） | TCP |
| 万维网 | HTTP（超文本传送协议） | TCP |
| 文件传送 | FTP（文件传送协议） | TCP |
### 5.1.3 运输层的端口
- **协议端口号（protocol port number）**，简称为**端口（port）**
- TCP/IP的运输层用一个16位**端口号**来标志一个端口
- 运输层的端口号
	- **服务器使用的端口号**，是固定的
		- **熟知端口号（well-known port number）**或**系统端口号**，数值为**0~1023**
		- **登记端口号**， 数值为**1024~49151**
	- **客户端使用的端口号**，存在时间是短期的
		- **短暂端口号**，数值为**49152~65535**

| 应用程序 | 熟知端口号 |
|--|--|
| FTP | 21 |
| TELNET | 23 |
| SMTP | 25 |
| DNS | 53 |
| TFTP | 69 |
| HTTP | 80 |
| SNMP | 161 |
| SNMP（trap） | 162 |
| https | 443 |
## 5.2 UDP概述
- UDP的主要特点
	- UDP是**无连接**的
	- UDP使用**尽最大努力交付**，即不保证可靠交付
	- UDP是**面向报文**的，**保留应用层交下来的报文的边界**
	- **UDP没有拥塞控制**
	- **UDP支持一对一、一对多、多对一和多对多的交互通信**
	- **UDP的首部开销小**，只有8个字节
### 5.2.2 UDP的首部格式
- UDP的首部
	- **首部字段**，每个字段的长度都是两个字节
		- **源端口**
		- **目的端口**
		- **长度** 
			- **其最小值是8（仅有首部）**
		- **校验和**
	- **数据字段**
- 接受方UDP发现收到的报文中的**目的端口号不正确**，就丢弃该报文，并由**ICMP**发送**“端口不可到达”差错报文**给发送方
- UDP不需要套接字
- 12字节伪首部
	- **源IP地址**，**4**字节
	- **目的IP地址**，**4**字节
	- **IP首部中的协议字段**，**1**字节，对于UDP，此协议字段值为**17**
	- **全零字段**，**1**字节
	- **UDP用户数据报长度**，**2**字节
- UDP的检验和是把**伪首部**、**首部**和**数据部分**一起都检验
	- 发送方
		1. 先将检验和字段置零
		2. 再用全零字节填充报文至偶数个字节
		3. 然后按二进制反码计算16位字的和
		4. 将计算结果取反得到检验和
	- 接收方
		1. 先用全零字节填充报文至偶数个字节
		2. 然后按二进制反码计算16位字的和
		3. **当无差错时其结果应为全1**
## 5.3 传输控制协议TCP概述
TODO
## 5.8 TCP的拥塞控制
### 5.8.1 拥塞控制的一般原理
- **拥塞（congestion）**
- 在计算机网络中的**链路容量（即带宽）**、交换结点中的**缓存**和**交换机**等，都是网络的资源
- 出现网络拥塞的条件
$$\sum 对资源的需求>可用资源$$
- **所谓拥塞控制就是防止过多的数据注入到网络中，这样就可以使网络中的路由器或链路不致过载**
- 拥塞控制的前提
	- **网络能够承受现有的网络负荷**
- 拥塞控制是一个**全局性**的过程
- **流量控制往往是指点对点通信量的控制**，是个**端到端**的问题
- 拥塞控制
	- 开环控制
	- 闭环控制
### 5.8.2 TCP的拥塞控制方法
- TCP进行拥塞控制的算法有四种
	- **慢开始（slow-start）**
	- **拥塞避免（congestion）**
	- **快重传（fast restransmit）**
	- **快恢复（fast recovery）**
- **慢开始门限**
- **3-ACK**
- 发送方的窗口的上限值
$$发送方窗口的上限值=Min[rwnd, cwnd]$$
### 5.8.3 主动队列管理AQM
- **尾部丢弃策略（tail-drop policy）**（网络层）
- **全局同步（global syncronization）**
- **主动队列管理AQM（Active Queue Management）**
	- **随机早期检查RED（Random Early Detection）**
		1. 若**平均队列长度**小于**最小门限**，则把新到达的分组放入队列进行排队
		2. **若平均队列长度**超过**最大门限**，则把新到达的分组放弃
		3. **若平均队列长度**在**最小门限**和**最大门限**之间，则按照某一个**丢弃概率p**把新到达的分组丢弃


<!--stackedit_data:
eyJoaXN0b3J5IjpbLTY5NjkwNjQ0NCwyMDIzNTk0MzY2LC0zNz
Y4NzUzMiw1NDE2OTA5NTAsLTI3NDU4NjcxMyw5OTUwOTE1ODMs
LTEzNjAwMDkyMzksLTIwOTA0NTE3MTcsMTU2NTg1MDYyLDIwND
cyNTM0ODEsMjExMTYwMjE1MSwtNTg4NDY3ODkzLDE0OTg1OTU0
NTQsNzM5OTI3ODldfQ==
-->